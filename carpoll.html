<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Bootstrap CSS for styling -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* Additional styling */
        #map {
            height: 400px; /* Set the height of the map */
            width: 100%; /* Set the width of the map */
        }
        .container {
            max-width: 800px; /* Limit the container width for better appearance */
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Select Location and Time for Voting Discussion</h2>
    <div id="map"></div> <!-- Map placeholder -->

    <div class="form-group">
        <label for="locationSelect">Choose a Location:</label>
        <select class="form-control" id="locationSelect">
            <!-- Options will be dynamically added here -->
        </select>
    </div>

    <div class="form-group">
        <label for="timeSelect">Choose a Time:</label>
        <input type="datetime-local" class="form-control" id="timeSelect">
    </div>

    <button class="btn btn-primary">Submit</button>
</div>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // Function to calculate distance between two lat-lon points
    function getDistanceFromLatLonInMiles(lat1, lon1, lat2, lon2) {
        var R = 3959; // Radius of the earth in miles
        var dLat = deg2rad(lat2 - lat1);
        var dLon = deg2rad(lon2 - lon1);
        var a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c; // Distance in miles
        return d;
    }
    
    function deg2rad(deg) {
        return deg * (Math.PI / 180);
    }
    

    // Function to load locations from a JSON file
    async function loadLocations() {
        const response = await fetch('./locations.json');
        const locations = await response.json();

        console.log("locations "+locations)
        return locations;
    }

    // Function to sort locations by distance and update the dropdown
    async function sortLocationsByDistance(userLat, userLon) {
        let locations = await loadLocations();
        locations.forEach(location => {
            location.distance = getDistanceFromLatLonInMiles(userLat, userLon, location.latitude, location.longitude);
        });

        // Sort locations by the 'distance' property
        locations.sort((a, b) => a.distance - b.distance);

        updateLocationDropdown(locations);
    }

    // Function to update the location dropdown
    function updateLocationDropdown(sortedLocations) {
        const select = document.getElementById('locationSelect');
        select.innerHTML = ''; // Clear existing options

        sortedLocations.forEach(location => {
            let option = new Option(location.address + ` (${location.distance.toFixed(2)} miles)`, location.address);
            select.add(option);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map and set its view to a default location
        var mymap = L.map('map').setView([51.505, -0.09], 13);

        // Set up the OSM layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(mymap);

        // Use HTML5 geolocation to get the user's current position
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                // Update the map's view to the current location
                mymap.setView([userLat, userLon], 13);

                // Add a marker for the user's current position
                L.marker([userLat, userLon]).addTo(mymap)
                    .bindPopup("Your Current Location").openPopup();

                // Sort locations by distance and update the dropdown
                await sortLocationsByDistance(userLat, userLon);

            }, () => {
                alert("Geolocation is not supported by this browser.");
            });
        }
    });
</script>

</body>
</html>
